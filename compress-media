#!/usr/bin/env bash
usage() {
    cat << EOF
-s <size> | --size <size> - sets target size of output file in mb
-h        | --help        - this message
Everything else considered to be a file path
EOF
}

export TEXTDOMAIN=ua.damglador.compress-media
if [ "$(stat -c %u "$0")" -eq "$(id -u)" ] && [ "$(id -u)" -ne 0 ]; then
    export TEXTDOMAINDIR=${XDG_DATA_HOME:-$HOME/.local/share}/locale
fi

l10n_title=$(gettext "Compress Media")
l10n_inputsize_msg=$(gettext "Input target size for the file in MiB")
l10n_err_mediasize_title=$(gettext "File is too big!")
l10n_err_mediasize_msg=$(gettext '«${file_name}» is too big (${size}MiB) for the target size of ${target_size_mb}MiB.
Input file must not be more than 8 times bigger than target size.')
l10n_err_filetype_msg=$(gettext "Unsupported file type")
l10n_err_ouputexists_msg=$(gettext "Output file already exists")

if [ -z "$1" ]; then
  usage
  exit
fi

ARGS=$(getopt -a -n resize -o s:h --long size,help -- "$@")
eval set -- "$ARGS"
while true; do
    case $1 in
        -s | --size)
            if [ "$2" == "kdialog" ]; then
                target_size_mb=$(kdialog --title "$l10n_title" --icon "insert-image" \
                    --inputbox "$l10n_inputsize_msg")
                if [ $? == "1" ] || [ -z "$target_size_mb" ]; then
                    exit
                fi
            else
                target_size_mb=$2
            fi
            shift 2;;
        -h | --help) usage; exit;;
        --) shift; break;;
    esac
done

target_size_mb="${target_size_mb:-10}"

# 200KB buffer from the requested size
buffer_kb=200
buffer_bytes=$((buffer_kb * 1024))

for file in "$@"; do
    file_name="$(basename "$file")"
    mime=$(file -b --mime-type "$file")
    ext="${file##*.}"

    if [[ "$mime" == video/* ]]; then
        size=$(( $(stat -c %s "$file") / 1024 / 1024 ))

        output="${file%."${ext}"}-${target_size_mb}MiB.mp4"
        if [ -f "$output" ]; then
            kdialog --title "$l10n_title" --warningcontinuecancel "$l10n_err_ouputexists_msg" || exit
        fi

        # apply 200KB buffer to target size
        target_size_bytes=$(( target_size_mb * 1024 * 1024 - buffer_bytes ))
        if (( target_size_bytes <= 0 )); then
            target_size_bytes=$(( target_size_mb * 1024 * 1024 ))
        fi
        target_size=$(( target_size_bytes * 8 ))

        duration=$(ffprobe -v error -show_entries format=duration \
                      -of default=noprint_wrappers=1:nokey=1 "$file")
        duration=${duration%.*}

        total_bitrate=$(( target_size / duration ))
        audio_bitrate=$(( 96 * 1000 ))
        video_bitrate=$(( total_bitrate - audio_bitrate ))

        # FIX: take the raw DBus reference exactly as KDE expects
        dbusRef=$(kdialog --title "$l10n_title" --progressbar "Compressing ${file_name}..." 100 | tr -d '\r')
        qdbus $dbusRef showCancelButton true

        fifo=$(mktemp -u)
        mkfifo "$fifo"

        ffmpeg -y -i "$file" \
            -vf "scale=-1:'min(720,ih)':flags=lanczos,fps=30" \
            -c:v libsvtav1 \
            -b:v "$video_bitrate" \
            -preset 4 \
            -g 240 \
            -pix_fmt yuv420p10le \
            -b:a "$audio_bitrate" \
            -c:a libopus \
            -ac 2 \
            -progress "$fifo" \
            -nostats \
            "$output" &
        pid=$!

        (
            while IFS='=' read -r key value; do
                case "$key" in
                    out_time_ms)
                        [[ "$value" =~ ^[0-9]+$ ]] || continue
                        cur_s=$(( value / 1000000 ))
                        percent=$(( cur_s * 100 / duration ))
                        (( percent > 100 )) && percent=100
                        qdbus $dbusRef Set "" "value" "$percent" 2>/dev/null
                        ;;
                esac
            done
        ) < "$fifo" &
        parse_pid=$!

        while kill -0 "$pid" 2>/dev/null; do
            qdbus $dbusRef >/dev/null 2>&1
            if [ $? -ne 0 ]; then
                kill "$pid" 2>/dev/null
                kill "$parse_pid" 2>/dev/null
                rm -f "$output" "$fifo"
                exit 1
            fi
            sleep 1
        done

        wait "$pid"
        rm -f "$fifo"

        qdbus $dbusRef Set "" "value" 100 2>/dev/null
        qdbus $dbusRef close 2>/dev/null

    elif [[ "$mime" == image/* ]]; then
        extent_kb=$(( target_size_mb * 1024 - buffer_kb ))
        if (( extent_kb <= 0 )); then
            extent_kb=$(( target_size_mb * 1024 ))
        fi
        magick "$file" -define "webp:extent=${extent_kb}KB" \
            "${file%."${ext}"}-${target_size_mb}MiB.webp"
    else
        kdialog --title "$l10n_title" --error "$l10n_err_filetype_msg"
    fi
done
